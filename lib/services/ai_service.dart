import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:flutter_dotenv/flutter_dotenv.dart';

class AiService {
  // =============================
  // üîê API KEY
  // =============================
  String get _apiKey {
    final key = dotenv.env['OPENAI_API_KEY'];
    if (key == null || key.isEmpty) {
      throw Exception('OPENAI_API_KEY is not set');
    }
    return key;
  }

  // =============================
  // üìÖ System controlled active day
  // =============================

  DateTime _activeDay = DateTime.now();

  void setActiveDay(DateTime day) {
    _activeDay = DateTime(day.year, day.month, day.day);
  }

  String _buildDayContext() {
    final d = _activeDay;

    final weekdays = [
      '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò','‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',
      '‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå','‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå','‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå',
    ];

    final months = [
      '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°',
    ];

    final thaiYear = d.year + 543;

    return '''
‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ${weekdays[d.weekday - 1]}
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d.day} ${months[d.month - 1]} $thaiYear
(‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡πÄ‡∏î‡∏≤)
''';
  }

  // =============================
  // üìÖ Monthly context
  // =============================

  String _buildMonthContext() {
    final d = _activeDay;

    final months = [
      '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];

    final thaiYear = d.year + 543;

    return '''
‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${months[d.month - 1]} $thaiYear
(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö)
''';
  }

  // =============================
  // ‚è∞ Report scheduling
  // =============================

  DateTime nextDailyReportTime() {
    final now = DateTime.now();
    return DateTime(now.year, now.month, now.day + 1);
  }

  bool isLastDayOfMonth(DateTime d) {
    final nextDay = DateTime(d.year, d.month, d.day + 1);
    return nextDay.month != d.month;
  }

  // =============================
  // üÜï Monthly auto report scheduler (NEW)
  // =============================

  DateTime nextMonthlyReportTime() {
    final now = DateTime.now();

    final firstNextMonth = DateTime(now.year, now.month + 1, 1);
    final lastDayThisMonth =
        firstNextMonth.subtract(const Duration(days: 1));

    final scheduled =
        DateTime(lastDayThisMonth.year,
            lastDayThisMonth.month,
            lastDayThisMonth.day,
            8, 0); // ‚è∞ 08:00

    if (now.isAfter(scheduled)) {
      final firstAfter =
          DateTime(now.year, now.month + 2, 1);
      final lastNext =
          firstAfter.subtract(const Duration(days: 1));

      return DateTime(
          lastNext.year,
          lastNext.month,
          lastNext.day,
          8, 0);
    }

    return scheduled;
  }

  bool shouldRunMonthlyReport() {
    final now = DateTime.now();
    final scheduled = nextMonthlyReportTime();

    return now.isAfter(
            scheduled.subtract(const Duration(minutes: 2))) &&
        now.isBefore(
            scheduled.add(const Duration(minutes: 2)));
  }

  // =============================
  // üßπ Extract clean JSON from AI
  // =============================
  String _extractJson(String raw) {
    final arrayStart = raw.indexOf('[');
    final arrayEnd = raw.lastIndexOf(']');

    if (arrayStart != -1 && arrayEnd != -1 && arrayEnd > arrayStart) {
      return raw.substring(arrayStart, arrayEnd + 1);
    }

    final objStart = raw.indexOf('{');
    final objEnd = raw.lastIndexOf('}');

    if (objStart != -1 && objEnd != -1 && objEnd > objStart) {
      return raw.substring(objStart, objEnd + 1);
    }

    throw FormatException('AI response is not valid JSON');
  }

  // =============================
  // üõ° Sanitize broken JSON
  // =============================
  String _sanitizeJson(String raw) {
    var s = raw.trim();

    final start = s.indexOf('[');
    final end = s.lastIndexOf(']');

    if (start == -1 || end == -1 || end <= start) {
      throw FormatException('No valid JSON array found');
    }

    s = s.substring(start, end + 1);
    s = s.replaceAll(RegExp(r'"\s*\n\s*'), '" ');
    s = s.replaceAll('\n', ' ');
    s = s.replaceAll('‚Äú', '"').replaceAll('‚Äù', '"');

    return s;
  }

  // =============================
  // üî¢ Decimal-safe number handling
  // =============================

  double? _parseHumanNumber(String input) {
    var s = input.trim();
    s = s.replaceAll(RegExp(r'[^0-9,.\-]'), '');

    if (s.isEmpty) return null;

    s = s.replaceAll(RegExp(r'^[,\.]+'), '');
    s = s.replaceAll(RegExp(r'[,\.]+$'), '');

    if (s.isEmpty) return null;

    final hasComma = s.contains(',');
    final hasDot = s.contains('.');

    if (hasComma && hasDot) {
      s = s.replaceAll(',', '');
    } else if (hasComma && !hasDot) {
      final last = s.lastIndexOf(',');
      final decimals = s.length - last - 1;

      if (decimals >= 1 && decimals <= 6) {
        s = s.replaceAll('.', '');
        s = s.replaceRange(last, last + 1, '.');
        s = s.replaceAll(',', '');
      } else {
        s = s.replaceAll(',', '');
      }
    }

    return double.tryParse(s);
  }

  List<double> _extractNumbersFromMessage(String message) {
    final matches =
        RegExp(r'[-]?\d[\d\s,\.]*\d|\d').allMatches(message);

    final out = <double>[];

    for (final m in matches) {
      final raw = m.group(0);
      if (raw == null) continue;

      final v = _parseHumanNumber(raw);
      if (v != null) out.add(v);
    }

    return out;
  }

  void _normalizeAmounts(
      List<Map<String, dynamic>> results, String message) {
    for (final item in results) {
      final a = item['amount'];

      if (a is num) {
        item['amount'] = a.toDouble();
      } else if (a is String) {
        final parsed = _parseHumanNumber(a) ?? double.tryParse(a);
        if (parsed != null) item['amount'] = parsed;
      }
    }

    final nums = _extractNumbersFromMessage(message);
    if (nums.isEmpty) return;

    if (results.length == 1) {
      results[0]['amount'] = nums.first;
      return;
    }

    if (nums.length == results.length) {
      for (var i = 0; i < results.length; i++) {
        results[i]['amount'] = nums[i];
      }
    }
  }

  // =============================
  // üì• Parse finance message
  // =============================
  Future<List<Map<String, dynamic>>> parseFinanceMessage(
    String message,
  ) async {
    final response = await http.post(
      Uri.parse('https://api.openai.com/v1/chat/completions'),
      headers: {
        'Authorization': 'Bearer $_apiKey',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'model': 'gpt-4.1-mini',
        'messages': [
          {'role': 'system', 'content': _financeParserPrompt},
          {'role': 'user', 'content': message},
        ],
        'temperature': 0.5,
        'max_tokens': 1000,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception(response.body);
    }

    final data = jsonDecode(response.body);
    final raw = data['choices'][0]['message']['content'];

    final extracted = _extractJson(raw);
    final safeJson = _sanitizeJson(extracted);
    final decoded = jsonDecode(safeJson);

    if (decoded is Map && decoded['error'] != null) {
      throw Exception(decoded['error']);
    }

    if (decoded is List) {
      final results = decoded.cast<Map<String, dynamic>>();
      _normalizeAmounts(results, message);
      return results;
    }

    throw Exception('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }

  // =============================
  // üïõ Daily behavior report
  // =============================
  Future<String> generateDailyBehaviorReport({
    required double income,
    required double expense,
  }) async {
    final dayContext = _buildDayContext();

    final response = await http.post(
      Uri.parse('https://api.openai.com/v1/chat/completions'),
      headers: {
        'Authorization': 'Bearer $_apiKey',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'model': 'gpt-4.1-mini',
        'messages': [
          {
            'role': 'user',
            'content': '''
$dayContext

‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: $income ‡∏ö‡∏≤‡∏ó
‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: $expense ‡∏ö‡∏≤‡∏ó

‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÑ‡∏´‡∏° ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏û‡∏π‡∏î‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
''',
          },
        ],
        'temperature': 0.4,
        'max_tokens': 500,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception(response.body);
    }

    final data = jsonDecode(response.body);
    return data['choices'][0]['message']['content'];
  }

  // =============================
  // üìä Generate financial insight
  // =============================
  Future<String> generateInsight({
    required double income,
    required double expense,
    required String transactionContext,
  }) async {
    final monthContext = _buildMonthContext();

    final response = await http.post(
      Uri.parse('https://api.openai.com/v1/chat/completions'),
      headers: {
        'Authorization': 'Bearer $_apiKey',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'model': 'gpt-4.1-mini',
        'messages': [
          {
            'role': 'system',
            'content': '''
‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏® : ‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢
‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢ : ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô/‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•/‡πÄ‡∏Ç‡∏¥‡∏ô‡∏á‡πà‡∏≤‡∏¢

‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö : ‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ô

‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á : ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô AI ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á

''',
          },
          {
            'role': 'user',
            'content': '''
$monthContext

‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:

‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:
- ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: $income ‡∏ö‡∏≤‡∏ó
- ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: $expense ‡∏ö‡∏≤‡∏ó

‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:
$transactionContext

‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏® : ‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢
‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢ : ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô/‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•/‡πÄ‡∏Ç‡∏¥‡∏ô‡∏á‡πà‡∏≤‡∏¢

‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏ö‡∏î‡∏∏‡∏• ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏§‡∏©‡∏é‡∏µ Zero-Based Budgeting (ZBB)
‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö : ‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ô

‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á : ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô AI ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏à‡∏≥ : ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏ô‡∏∞ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤) ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô
                ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
		‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ß

‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö : ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö
‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥  (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Emoji ‡πÑ‡∏î‡πâ)
‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡πÑ‡∏°‡πà‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á


‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà........‡∏ô‡∏∞‡∏Ñ‡∏∞'
    ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Emoji ‡πÅ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤

(Emoji) '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô....' ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏≠‡∏Å ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠

(Emoji) '‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á' ‡∏ä‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÇ‡∏î‡∏¢ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ‡∏ó‡∏§‡∏©‡∏é‡∏µ Financial Ratios Framework ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏±‡∏ö‡∏ô‡∏∞

(Emoji) '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ' ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô) ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÇ‡∏î‡∏¢‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏§‡∏©‡∏é‡∏µ Zero-Based Budgeting (ZBB) ‡πÅ‡∏•‡∏∞ Cash-Flow Forecasting ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏±‡∏ö‡∏ô‡∏∞

(Emoji) '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤' ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢ ‡∏û‡∏π‡∏î‡∏ï‡∏£‡∏á‡πÜ‡∏ô‡∏∞ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞

‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
(‡πÉ‡∏ä‡πâ Emoji ‡πÑ‡∏î‡πâ)

‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡∏Å‡∏±‡∏ö ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞
''',
          },
        ],
        'temperature': 0.35,
        'max_tokens': 2000,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception(response.body);
    }

    final data = jsonDecode(response.body);
    return data['choices'][0]['message']['content'];
  }

  // =============================
  // üìà Dashboard daily message (UNCHANGED)
  // =============================
  Future<String> generateDashboardMessage({
    required double balance,
    required double expense,
  }) async {
    final response = await http.post(
      Uri.parse('https://api.openai.com/v1/chat/completions'),
      headers: {
        'Authorization': 'Bearer $_apiKey',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'model': 'gpt-4.1-mini',
        'messages': [
          {
            'role': 'system',
            'content': '''
‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏® : ‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢
‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢ : ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô/‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•/‡πÄ‡∏Ç‡∏¥‡∏ô‡∏á‡πà‡∏≤‡∏¢

‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏ö‡∏î‡∏∏‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö : ‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ô

‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á : ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô AI ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö : ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö ‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Emoji ‡πÑ‡∏î‡πâ‡∏ô‡∏∞

''',
          },
          {
            'role': 'user',
            'content': '''

‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏® : ‡∏´‡∏ç‡∏¥‡∏á
‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢ : ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô/‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å/‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•/‡πÄ‡∏Ç‡∏¥‡∏ô‡∏á‡πà‡∏≤‡∏¢

‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö : ‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£
‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ô
‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∏‡∏ó‡∏≤‡∏ô‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤

‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á : ‡πÑ‡∏°‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô AI ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á

‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö : ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥

‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡πà 1 - 2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Å‡πá‡∏û‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
''',
          },
        ],
        'temperature': 0.7,
        'max_tokens': 100,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception(response.body);
    }

    final data = jsonDecode(response.body);
    return data['choices'][0]['message']['content'];
  }
}

// =============================
// üìú Finance parser system prompt (UNCHANGED 100%)
// =============================
const String _financeParserPrompt = '''
‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏® : ‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 
          ‡πÇ‡∏î‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô 
          ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
          ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏à‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û 
          (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô 
          (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢ object ‡πÉ‡∏ô array ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏à‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 
          ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô schema ‡πÅ‡∏•‡∏∞ ‡∏ï‡∏≤‡∏° ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö error:
{ "error": "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ" }

‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô array ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
[
  { "type": "income | expense", "amount": number, "category": string, "note": string }
]

‡∏Å‡∏é:
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà date
- ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏≠‡∏Å JSON
''';
